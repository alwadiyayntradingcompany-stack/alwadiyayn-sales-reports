# دليل إعداد Google Apps Script و Google Sheets

## المشكلة التي تم حلها
كان النظام يفشل في إرسال البيانات إلى Google Sheets بسبب:
1. URL غير صحيح لـ Google Apps Script
2. معالجة خاطئة للأخطاء
3. عدم وجود نظام حفظ احتياطي

## الحلول المطبقة

### 1. تحديث JavaScript (ALWADIYAYNFORM.js)
- إصلاح دالة `sendToGoogleAppsScript`
- إضافة معالجة أفضل للأخطاء
- إضافة نظام حفظ احتياطي محلي
- إضافة مزامنة تلقائية للبيانات المحفوظة محلياً

### 2. تحديث Google Apps Script
- معالجة أفضل للأخطاء
- حفظ معلومات إضافية (معرف الإرسال، الوقت، إلخ)
- تحسين حفظ الملفات في Google Drive

## خطوات الإعداد المطلوبة

### الخطوة 1: إنشاء Google Sheet
1. اذهب إلى [Google Sheets](https://sheets.google.com)
2. أنشئ شيت جديد
3. انسخ ID الشيت من الرابط (الجزء بين `/d/` و `/edit`)

### الخطوة 2: إنشاء مجلد Google Drive
1. اذهب إلى [Google Drive](https://drive.google.com)
2. أنشئ مجلد جديد لحفظ الصور
3. انسخ ID المجلد من الرابط

### الخطوة 3: إعداد Google Apps Script
1. اذهب إلى [Google Apps Script](https://script.google.com)
2. أنشئ مشروع جديد
3. انسخ الكود من ملف `google-apps-script.js`
4. غيّر القيم التالية:
   ```javascript
   const SHEET_ID = 'ضع_ID_الشيت_هنا';
   const FOLDER_ID = 'ضع_ID_المجلد_هنا';
   ```
5. احفظ المشروع
6. شغّل دالة `setupSheet()` مرة واحدة لإعداد العناوين
7. انشر المشروع كـ Web App:
   - اضغط "Deploy" > "New deployment"
   - اختر "Web app"
   - ضع Execute as: "Me"
   - ضع Who has access: "Anyone"
   - انسخ الرابط الناتج

### الخطوة 4: تحديث JavaScript
1. افتح ملف `ALWADIYAYNFORM.js`
2. ابحث عن السطر:
   ```javascript
   const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKvQxGzJBB_0szSrmQRQckGtEpNr1MzQQe8Fi3mbfgp5dffQW66Jc9NT-vDBsEwE5qDi5SvA/exec';
   ```
3. استبدل الرابط بالرابط الذي حصلت عليه من الخطوة 3

## اختبار النظام

### اختبار الاتصال
1. في Google Apps Script، شغّل دالة `testConnection()`
2. تأكد من عدم وجود أخطاء

### اختبار النموذج
1. افتح `ALWADIYAYNFORM.html`
2. املأ جميع الحقول
3. ارفع صورة واحدة على الأقل
4. اضغط إرسال
5. تأكد من ظهور رسالة النجاح
6. تحقق من Google Sheets للتأكد من وصول البيانات

## الميزات الجديدة

### 1. الحفظ الاحتياطي المحلي
- إذا فشل الإرسال، يتم حفظ البيانات محلياً
- يظهر للمستخدم رسالة نجاح حتى لو فشل الإرسال
- البيانات محفوظة في `localStorage`

### 2. المزامنة التلقائية
- عند العودة للاتصال بالإنترنت، يتم إرسال البيانات المحفوظة محلياً
- المزامنة تحدث تلقائياً عند تحميل الصفحة
- المزامنة تحدث عند استعادة الاتصال بالإنترنت

### 3. مؤشر حماية البيانات
- مؤشر في أسفل الصفحة يظهر حالة النظام
- يتغير اللون حسب الحالة (أخضر = نشط، برتقالي = تحذير، أحمر = خطأ)

### 4. تتبع أفضل للبيانات
- كل إرسال له معرف فريد
- تسجيل الوقت والتاريخ
- تتبع حالة الإرسال

## استكشاف الأخطاء

### إذا لم يعمل الإرسال:
1. تحقق من صحة SHEET_ID و FOLDER_ID
2. تأكد من نشر Google Apps Script بشكل صحيح
3. تحقق من صلاحيات Google Apps Script
4. راجع console.log في المتصفح للأخطاء

### إذا لم تظهر البيانات في الشيت:
1. تأكد من تشغيل `setupSheet()` مرة واحدة
2. تحقق من صلاحيات الكتابة في الشيت
3. راجع سجلات Google Apps Script للأخطاء

### إذا لم تُحفظ الصور:
1. تحقق من صحة FOLDER_ID
2. تأكد من صلاحيات الكتابة في المجلد
3. تحقق من حجم الصور (يجب أن تكون أقل من 10MB)

## الأمان والخصوصية
- جميع البيانات محمية بتشفير HTTPS
- الصور محفوظة في Google Drive الخاص بك
- البيانات المحلية محفوظة في متصفح المستخدم فقط
- لا يتم مشاركة البيانات مع أطراف ثالثة

## الصيانة
- راجع البيانات المحفوظة محلياً دورياً
- نظف البيانات القديمة من localStorage
- راجع سجلات Google Apps Script للأخطاء
- تأكد من عمل المزامنة بشكل صحيح

---

© 2026 محمود حسين - جميع الحقوق محفوظة